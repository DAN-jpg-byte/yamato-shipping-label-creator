import urllib.parse
import re

def decode_fully(text):
    """URLエンコードがなくなるまで完全にデコードする"""
    while "%" in text:
        decoded = urllib.parse.unquote(text)
        if decoded == text:
            break
        text = decoded
    return text

def analyze_yamato_line_url(url):
    """URLを解析し、整形されたテキストを返す"""
    parsed = urllib.parse.urlparse(url)
    qs = urllib.parse.parse_qs(parsed.query)
    return_uri = qs.get('returnUri', [None])[0]
    
    if not return_uri:
        return "エラー: returnUriが見つかりません。"

    try:
        parsed_2 = urllib.parse.urlparse(return_uri)
        qs_2 = urllib.parse.parse_qs(parsed_2.query)
        redirect_uri = qs_2.get('redirect_uri', [None])[0]

        parsed_3 = urllib.parse.urlparse(redirect_uri)
        qs_3 = urllib.parse.parse_qs(parsed_3.query)
        return_url = qs_3.get('returnUrl', [None])[0]
    except Exception as e:
        return f"エラー: URL構造の解析に失敗しました ({e})"

    if return_url:
        decoded_content = decode_fully(return_url)
        
        if "text=" in decoded_content:
                    # メッセージ全体を取得
                    message_part = decoded_content.split("text=")[-1]
                    
                    # 1. 余計なパラメータ「&from=line_scheme...」を消す
                    # URLとして必要な部分は残しつつ、LINE専用のゴミだけを削除します
                    cleaned_message = message_part.replace("&from=line_scheme", "")
                    
                    # 2. 前後の不要な空白を消す
                    cleaned_message = cleaned_message.strip()

                    return cleaned_message
                    
    return "エラー: メッセージ内容を取得できませんでした。"



if __name__ == "__main__":
    # --- 使い方 ---
    target_url = "https://access.line.me/oauth2/v2.1/login?returnUri=%2Foauth2%2Fv2.1%2Fauthorize%2Fconsent%3Fresponse_type%3Dcode%26client_id%3D1446101138%26state%3D38db24a1fccd90ae3f570b3f726e20%26redirect_uri%3Dhttps%253A%252F%252Fsocial-plugins.line.me%252Flineit%252FloginCallback%253FreturnUrl%253Dhttps%25253A%25252F%25252Fsocial-plugins.line.me%25252Flineit%25252Fshare%25253Furl%25253Dhttps%25253A%25252F%25252Fsp-send.kuronekoyamato.co.jp%25252F%252526text%25253D%252525F4%25252580%25252582%252525B2%252525E3%25252581%2525258A%252525E5%252525B1%2525258A%252525E3%25252581%25252591%252525E5%25252585%25252588%252525E5%25252585%252525A5%252525E5%2525258A%2525259B%252525E3%25252583%252525AA%252525E3%25252582%252525AF%252525E3%25252582%252525A8%252525E3%25252582%252525B9%252525E3%25252583%25252588%252525F4%25252580%25252582%252525B2%2525250D%2525250A%252525E3%25252583%252525A4%252525E3%25252583%2525259E%252525E3%25252583%25252588%252525E9%25252581%2525258B%252525E8%252525BC%252525B8%252525E3%25252581%252525AE%252525E5%252525AE%25252585%252525E6%25252580%252525A5%252525E4%252525BE%252525BF%252525E3%25252582%25252592%252525E4%252525BD%252525BF%252525E7%25252594%252525A8%252525E3%25252581%25252597%252525E3%25252581%252525A6%252525E3%25252581%2525258A%252525E8%2525258D%252525B7%252525E7%25252589%252525A9%252525E3%25252582%25252592%252525E9%25252580%25252581%252525E3%25252582%2525258A%252525E3%25252581%252525BE%252525E3%25252581%25252599%252525E3%25252580%25252582%252525E5%2525258F%25252597%252525E3%25252581%25252591%252525E5%2525258F%25252596%252525E3%25252582%2525258A%252525E6%25252596%252525B9%252525E6%252525B3%25252595%252525E3%25252582%25252592%252525E8%252525A8%252525AD%252525E5%252525AE%2525259A%252525E3%25252581%25252597%252525E3%25252581%252525A6%252525E3%25252581%2525258F%252525E3%25252581%252525A0%252525E3%25252581%25252595%252525E3%25252581%25252584%252525E3%25252580%25252582%2525250D%2525250A%25252520---------------------------%25252520%2525250D%2525250A%25252520%2525253C%252525E3%25252583%252525A1%252525E3%25252583%25252583%252525E3%25252582%252525BB%252525E3%25252583%252525BC%252525E3%25252582%252525B8%2525253E%25252520%2525250D%2525250A%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%2525250D%2525250A%25252520---------------------------%25252520%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E7%25252599%252525BA%252525E9%25252580%25252581%252525E4%252525BA%25252588%252525E5%252525AE%2525259A%252525E6%25252597%252525A5%252525EF%252525BC%2525259A2%252525E6%2525259C%252525889%252525E6%25252597%252525A5%25252520%2528%252525E6%2525259C%25252588%2529%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E5%25252593%25252581%252525E5%25252590%2525258D%252525EF%252525BC%2525259A%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%252525EF%252525BD%25252597%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E5%25252580%2525258B%252525E6%25252595%252525B0%252525EF%252525BC%2525259A1%252525E5%25252580%2525258B%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E5%2525258C%252525BF%252525E5%25252590%2525258D%252525E9%25252585%2525258D%252525E9%25252580%25252581%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E4%252525BB%252525A5%252525E4%252525B8%2525258B%252525E3%25252581%252525AEURL%252525E3%25252582%25252588%252525E3%25252582%2525258A%252525E3%25252580%25252581%252525E5%2525258F%25252597%252525E3%25252581%25252591%252525E5%2525258F%25252596%252525E3%25252582%2525258A%252525E6%25252596%252525B9%252525E6%252525B3%25252595%252525E3%25252582%25252592%252525E5%25252585%252525A5%252525E5%2525258A%2525259B%252525E3%25252581%25252597%252525E3%25252581%252525A6%252525E3%25252581%2525258F%252525E3%25252581%252525A0%252525E3%25252581%25252595%252525E3%25252581%25252584%252525E3%25252580%25252582%25252520%2525250D%2525250A%25252520https%2525253A%2525252F%2525252Fsp-send.kuronekoyamato.co.jp%2525252FsmpTaqWeb%2525252FViwb9001Action_doInit.action%2525253FrequestKey%2525253DyiT4mH4hkYB5dlH7mrriY7o1Virz6q1x%25252526openExternalBrowser%2525253D1%25252520%2525250D%2525250A%252525E2%25252580%252525BB%252525E5%25252585%252525A5%252525E5%2525258A%2525259B%252525E6%2525259C%2525259F%252525E9%25252599%25252590%252525EF%252525BC%2525259A2%252525E6%2525259C%2525258816%252525E6%25252597%252525A5%25252520%2528%252525E6%2525259C%25252588%2529%2525250D%2525250A%252525E2%25252580%252525BB%252525E3%25252581%25252593%252525E3%25252581%252525AE%252525E3%25252581%2525258A%252525E8%2525258D%252525B7%252525E7%25252589%252525A9%252525E3%25252581%252525AF%252525E3%25252581%2525258A%252525E4%252525BA%25252592%252525E3%25252581%25252584%252525E3%25252581%252525AE%252525E4%252525BD%2525258F%252525E6%25252589%25252580%252525E3%25252583%252525BB%252525E5%25252590%2525258D%252525E5%25252589%2525258D%252525E3%25252583%252525BB%252525E9%2525259B%252525BB%252525E8%252525A9%252525B1%252525E7%25252595%252525AA%252525E5%2525258F%252525B7%252525E3%25252582%25252592%252525E9%2525259D%2525259E%252525E8%252525A1%252525A8%252525E7%252525A4%252525BA%252525E3%25252581%252525A7%252525E3%25252581%2525258A%252525E5%252525B1%2525258A%252525E3%25252581%25252591%252525E3%25252581%25252597%252525E3%25252581%252525BE%252525E3%25252581%25252599%252525E3%25252580%25252582%252526from%25253Dline_scheme%26scope%3Dopenid%2520profile%2520friends%2520groups%2520timeline.post%2520message.write&loginChannelId=1446101138&loginState=IaWgJzzFnMZ24vs8t6m4fF#/"
    mailtext = analyze_yamato_line_url(target_url)
    print(mailtext)