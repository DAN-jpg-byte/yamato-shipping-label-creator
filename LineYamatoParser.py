import urllib.parse
import re

def decode_fully(text):
    """URLエンコードがなくなるまで完全にデコードする"""
    while "%" in text:
        decoded = urllib.parse.unquote(text)
        if decoded == text:
            break
        text = decoded
    return text

def analyze_yamato_line_url(url):
    """URLを解析し、整形されたメッセージを返す"""
    try:
        # 1. 複雑な入れ子URLを順番にほどく
        parsed = urllib.parse.urlparse(url)
        qs = urllib.parse.parse_qs(parsed.query)
        return_uri = qs.get('returnUri', [None])[0]
        
        parsed_2 = urllib.parse.urlparse(return_uri)
        qs_2 = urllib.parse.parse_qs(parsed_2.query)
        redirect_uri = qs_2.get('redirect_uri', [None])[0]

        parsed_3 = urllib.parse.urlparse(redirect_uri)
        qs_3 = urllib.parse.parse_qs(parsed_3.query)
        return_url = qs_3.get('returnUrl', [None])[0]

        if return_url:
            if "text=" in return_url:
                # 2. URLを「text=」を境に2つに分ける
                url_part, text_part = return_url.split("text=", 1)
                
                # 3. メッセージ本文をデコードしてきれいにする
                # 注: ここで一度完全にデコードされるため、%2B は + になってしまう
                decoded_text = decode_fully(text_part)
                cleaned_text = decoded_text.replace("&from=line_scheme", "").strip()
                
                # 4. 上書き用のURL（base_url）を抽出する
                raw_url_part = urllib.parse.unquote(url_part)
                target_domain = "https://sp-send.kuronekoyamato.co.jp/"
                
                base_url = ""
                if target_domain in raw_url_part:
                    start_pos = raw_url_part.find(target_domain)
                    base_url = raw_url_part[start_pos:]
                    base_url = base_url.split("&")[0] if "&" in base_url else base_url
                else:
                    base_url = raw_url_part.split("&")[0]

                # --- 修正箇所開始 ---
                # base_urlにキーがない場合でも、本文(cleaned_text)の中のURLを修正して採用するロジックに変更
                
                target_url = base_url
                
                # base_url に requestKey がない場合、本文からURLを探す
                if "requestKey=" not in target_url:
                    match_url = re.search(r'(https://sp-send\.kuronekoyamato\.co\.jp/[^\s]+)', cleaned_text)
                    if match_url:
                        target_url = match_url.group(1)

                # URLの中に requestKey がある場合、記号(+や/)を安全な形式にエンコードし直す
                if "requestKey=" in target_url:
                    match = re.search(r'requestKey=([^&]+)', target_url)
                    if match:
                        key_val = match.group(1)
                        # + を %2B に、/ を %2F に変換
                        safe_key = urllib.parse.quote(key_val, safe='') 
                        target_url = target_url.replace("requestKey=" + key_val, "requestKey=" + safe_key)
                
                # メッセージ内のURLを、修正済みのURL(target_url)で置き換える
                res_text = re.sub(r'https://sp-send\.kuronekoyamato\.co\.jp/[^\s]+', target_url, cleaned_text)
                
                return res_text
                # --- 修正箇所終了 ---

    except Exception as e:
        return f"エラー: {e}"
    
    return "解析失敗"

if __name__ == "__main__":
    # テスト用（エラーになったfのケースに近いもの）
    target_url = "https://access.line.me/oauth2/v2.1/login?returnUri=%2Foauth2%2Fv2.1%2Fauthorize%2Fconsent%3Fresponse_type%3Dcode%26client_id%3D1446101138%26state%3Df42d422012a1fc51d3643ef2e10b59%26redirect_uri%3Dhttps%253A%252F%252Fsocial-plugins.line.me%252Flineit%252FloginCallback%253FreturnUrl%253Dhttps%25253A%25252F%25252Fsocial-plugins.line.me%25252Flineit%25252Fshare%25253Furl%25253Dhttps%25253A%25252F%25252Fsp-send.kuronekoyamato.co.jp%25252F%252526text%25253D%252525F4%25252580%25252582%252525B2%252525E3%25252581%2525258A%252525E5%252525B1%2525258A%252525E3%25252581%25252591%252525E5%25252585%25252588%252525E5%25252585%252525A5%252525E5%2525258A%2525259B%252525E3%25252583%252525AA%252525E3%25252582%252525AF%252525E3%25252582%252525A8%252525E3%25252582%252525B9%252525E3%25252583%25252588%252525F4%25252580%25252582%252525B2%2525250D%2525250A%252525E3%25252583%252525A4%252525E3%25252583%2525259E%252525E3%25252583%25252588%252525E9%25252581%2525258B%252525E8%252525BC%252525B8%252525E3%25252581%252525AE%252525E5%252525AE%25252585%252525E6%25252580%252525A5%252525E4%252525BE%252525BF%252525E3%25252582%25252592%252525E4%252525BD%252525BF%252525E7%25252594%252525A8%252525E3%25252581%25252597%252525E3%25252581%252525A6%252525E3%25252581%2525258A%252525E8%2525258D%252525B7%252525E7%25252589%252525A9%252525E3%25252582%25252592%252525E9%25252580%25252581%252525E3%25252582%2525258A%252525E3%25252581%252525BE%252525E3%25252581%25252599%252525E3%25252580%25252582%252525E5%2525258F%25252597%252525E3%25252581%25252591%252525E5%2525258F%25252596%252525E3%25252582%2525258A%252525E6%25252596%252525B9%252525E6%252525B3%25252595%252525E3%25252582%25252592%252525E8%252525A8%252525AD%252525E5%252525AE%2525259A%252525E3%25252581%25252597%252525E3%25252581%252525A6%252525E3%25252581%2525258F%252525E3%25252581%252525A0%252525E3%25252581%25252595%252525E3%25252581%25252584%252525E3%25252580%25252582%2525250D%2525250A%25252520---------------------------%25252520%2525250D%2525250A%25252520%2525253C%252525E3%25252583%252525A1%252525E3%25252583%25252583%252525E3%25252582%252525BB%252525E3%25252583%252525BC%252525E3%25252582%252525B8%2525253E%25252520%2525250D%2525250A%252525EF%252525BD%2525258B%2525250D%2525250A%25252520---------------------------%25252520%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E7%25252599%252525BA%252525E9%25252580%25252581%252525E4%252525BA%25252588%252525E5%252525AE%2525259A%252525E6%25252597%252525A5%252525EF%252525BC%2525259A2%252525E6%2525259C%2525258814%252525E6%25252597%252525A5%25252520%2528%252525E5%2525259C%2525259F%2529%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E5%25252593%25252581%252525E5%25252590%2525258D%252525EF%252525BC%2525259A%252525EF%252525BD%2525258B%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E5%25252580%2525258B%252525E6%25252595%252525B0%252525EF%252525BC%2525259A1%252525E5%25252580%2525258B%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E5%2525258C%252525BF%252525E5%25252590%2525258D%252525E9%25252585%2525258D%252525E9%25252580%25252581%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E4%252525BB%252525A5%252525E4%252525B8%2525258B%252525E3%25252581%252525AEURL%252525E3%25252582%25252588%252525E3%25252582%2525258A%252525E3%25252580%25252581%252525E5%2525258F%25252597%252525E3%25252581%25252591%252525E5%2525258F%25252596%252525E3%25252582%2525258A%252525E6%25252596%252525B9%252525E6%252525B3%25252595%252525E3%25252582%25252592%252525E5%25252585%252525A5%252525E5%2525258A%2525259B%252525E3%25252581%25252597%252525E3%25252581%252525A6%252525E3%25252581%2525258F%252525E3%25252581%252525A0%252525E3%25252581%25252595%252525E3%25252581%25252584%252525E3%25252580%25252582%25252520%2525250D%2525250A%25252520https%2525253A%2525252F%2525252Fsp-send.kuronekoyamato.co.jp%2525252FsmpTaqWeb%2525252FViwb9001Action_doInit.action%2525253FrequestKey%2525253DeXRn2%252525252BFKjnhUjhKDOJ4AmBvhmLNaW1j%252525252F%25252526openExternalBrowser%2525253D1%25252520%2525250D%2525250A%252525E2%25252580%252525BB%252525E5%25252585%252525A5%252525E5%2525258A%2525259B%252525E6%2525259C%2525259F%252525E9%25252599%25252590%252525EF%252525BC%2525259A2%252525E6%2525259C%2525258818%252525E6%25252597%252525A5%25252520%2528%252525E6%252525B0%252525B4%2529%2525250D%2525250A%252525E2%25252580%252525BB%252525E3%25252581%25252593%252525E3%25252581%252525AE%252525E3%25252581%2525258A%252525E8%2525258D%252525B7%252525E7%25252589%252525A9%252525E3%25252581%252525AF%252525E3%25252581%2525258A%252525E4%252525BA%25252592%252525E3%25252581%25252584%252525E3%25252581%252525AE%252525E4%252525BD%2525258F%252525E6%25252589%25252580%252525E3%25252583%252525BB%252525E5%25252590%2525258D%252525E5%25252589%2525258D%252525E3%25252583%252525BB%252525E9%2525259B%252525BB%252525E8%252525A9%252525B1%252525E7%25252595%252525AA%252525E5%2525258F%252525B7%252525E3%25252582%25252592%252525E9%2525259D%2525259E%252525E8%252525A1%252525A8%252525E7%252525A4%252525BA%252525E3%25252581%252525A7%252525E3%25252581%2525258A%252525E5%252525B1%2525258A%252525E3%25252581%25252591%252525E3%25252581%25252597%252525E3%25252581%252525BE%252525E3%25252581%25252599%252525E3%25252580%25252582%252526from%25253Dline_scheme%26scope%3Dopenid%2520profile%2520friends%2520groups%2520timeline.post%2520message.write&loginChannelId=1446101138&loginState=pcvVza7GXIMrxTcq3Q9FLo#/"
    print("このファイルを実行して文法エラーがないか確認してください")
    print(analyze_yamato_line_url(target_url))

    print("--------------------------------")

    target_url2="https://access.line.me/oauth2/v2.1/login?returnUri=%2Foauth2%2Fv2.1%2Fauthorize%2Fconsent%3Fresponse_type%3Dcode%26client_id%3D1446101138%26state%3D00960e4c2ceda8bdcac6467e0527ab%26redirect_uri%3Dhttps%253A%252F%252Fsocial-plugins.line.me%252Flineit%252FloginCallback%253FreturnUrl%253Dhttps%25253A%25252F%25252Fsocial-plugins.line.me%25252Flineit%25252Fshare%25253Furl%25253Dhttps%25253A%25252F%25252Fsp-send.kuronekoyamato.co.jp%25252F%252526text%25253D%252525F4%25252580%25252582%252525B2%252525E3%25252581%2525258A%252525E5%252525B1%2525258A%252525E3%25252581%25252591%252525E5%25252585%25252588%252525E5%25252585%252525A5%252525E5%2525258A%2525259B%252525E3%25252583%252525AA%252525E3%25252582%252525AF%252525E3%25252582%252525A8%252525E3%25252582%252525B9%252525E3%25252583%25252588%252525F4%25252580%25252582%252525B2%2525250D%2525250A%252525E3%25252583%252525A4%252525E3%25252583%2525259E%252525E3%25252583%25252588%252525E9%25252581%2525258B%252525E8%252525BC%252525B8%252525E3%25252581%252525AE%252525E5%252525AE%25252585%252525E6%25252580%252525A5%252525E4%252525BE%252525BF%252525E3%25252582%25252592%252525E4%252525BD%252525BF%252525E7%25252594%252525A8%252525E3%25252581%25252597%252525E3%25252581%252525A6%252525E3%25252581%2525258A%252525E8%2525258D%252525B7%252525E7%25252589%252525A9%252525E3%25252582%25252592%252525E9%25252580%25252581%252525E3%25252582%2525258A%252525E3%25252581%252525BE%252525E3%25252581%25252599%252525E3%25252580%25252582%252525E5%2525258F%25252597%252525E3%25252581%25252591%252525E5%2525258F%25252596%252525E3%25252582%2525258A%252525E6%25252596%252525B9%252525E6%252525B3%25252595%252525E3%25252582%25252592%252525E8%252525A8%252525AD%252525E5%252525AE%2525259A%252525E3%25252581%25252597%252525E3%25252581%252525A6%252525E3%25252581%2525258F%252525E3%25252581%252525A0%252525E3%25252581%25252595%252525E3%25252581%25252584%252525E3%25252580%25252582%2525250D%2525250A%25252520---------------------------%25252520%2525250D%2525250A%25252520%2525253C%252525E3%25252583%252525A1%252525E3%25252583%25252583%252525E3%25252582%252525BB%252525E3%25252583%252525BC%252525E3%25252582%252525B8%2525253E%25252520%2525250D%2525250A%252525EF%252525BD%25252585%2525250D%2525250A%25252520---------------------------%25252520%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E7%25252599%252525BA%252525E9%25252580%25252581%252525E4%252525BA%25252588%252525E5%252525AE%2525259A%252525E6%25252597%252525A5%252525EF%252525BC%2525259A2%252525E6%2525259C%2525258814%252525E6%25252597%252525A5%25252520%2528%252525E5%2525259C%2525259F%2529%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E5%25252593%25252581%252525E5%25252590%2525258D%252525EF%252525BC%2525259A%252525EF%252525BD%25252585%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E5%25252580%2525258B%252525E6%25252595%252525B0%252525EF%252525BC%2525259A1%252525E5%25252580%2525258B%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E5%2525258C%252525BF%252525E5%25252590%2525258D%252525E9%25252585%2525258D%252525E9%25252580%25252581%2525250D%2525250A%25252520%252525E2%25252596%252525A0%252525E4%252525BB%252525A5%252525E4%252525B8%2525258B%252525E3%25252581%252525AEURL%252525E3%25252582%25252588%252525E3%25252582%2525258A%252525E3%25252580%25252581%252525E5%2525258F%25252597%252525E3%25252581%25252591%252525E5%2525258F%25252596%252525E3%25252582%2525258A%252525E6%25252596%252525B9%252525E6%252525B3%25252595%252525E3%25252582%25252592%252525E5%25252585%252525A5%252525E5%2525258A%2525259B%252525E3%25252581%25252597%252525E3%25252581%252525A6%252525E3%25252581%2525258F%252525E3%25252581%252525A0%252525E3%25252581%25252595%252525E3%25252581%25252584%252525E3%25252580%25252582%25252520%2525250D%2525250A%25252520https%2525253A%2525252F%2525252Fsp-send.kuronekoyamato.co.jp%2525252FsmpTaqWeb%2525252FViwb9001Action_doInit.action%2525253FrequestKey%2525253DUiuANEIfmHxMfGdyxdPScraUhglXlkB2%25252526openExternalBrowser%2525253D1%25252520%2525250D%2525250A%252525E2%25252580%252525BB%252525E5%25252585%252525A5%252525E5%2525258A%2525259B%252525E6%2525259C%2525259F%252525E9%25252599%25252590%252525EF%252525BC%2525259A2%252525E6%2525259C%2525258818%252525E6%25252597%252525A5%25252520%2528%252525E6%252525B0%252525B4%2529%2525250D%2525250A%252525E2%25252580%252525BB%252525E3%25252581%25252593%252525E3%25252581%252525AE%252525E3%25252581%2525258A%252525E8%2525258D%252525B7%252525E7%25252589%252525A9%252525E3%25252581%252525AF%252525E3%25252581%2525258A%252525E4%252525BA%25252592%252525E3%25252581%25252584%252525E3%25252581%252525AE%252525E4%252525BD%2525258F%252525E6%25252589%25252580%252525E3%25252583%252525BB%252525E5%25252590%2525258D%252525E5%25252589%2525258D%252525E3%25252583%252525BB%252525E9%2525259B%252525BB%252525E8%252525A9%252525B1%252525E7%25252595%252525AA%252525E5%2525258F%252525B7%252525E3%25252582%25252592%252525E9%2525259D%2525259E%252525E8%252525A1%252525A8%252525E7%252525A4%252525BA%252525E3%25252581%252525A7%252525E3%25252581%2525258A%252525E5%252525B1%2525258A%252525E3%25252581%25252591%252525E3%25252581%25252597%252525E3%25252581%252525BE%252525E3%25252581%25252599%252525E3%25252580%25252582%252526from%25253Dline_scheme%26scope%3Dopenid%2520profile%2520friends%2520groups%2520timeline.post%2520message.write&loginChannelId=1446101138&loginState=POB2NnS1tdDqeBHmNtZZ1q#/"
    print(analyze_yamato_line_url(target_url2))